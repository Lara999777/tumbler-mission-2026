
<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸ - í…€ë¸”ëŸ¬ ë¯¸ì…˜</title>
<style>
    :root {
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --primary-dark: #5b21b6;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --radius: 16px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--gray-900);
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
    }

    /* ë¸Œëœë“œ íƒ€ì´í‹€ */
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
    }

    .brand img {
      width: 42px;
      height: 42px;
      object-fit: contain;
      padding: 6px;
      background: var(--gray-100);
      border-radius: 12px;
    }

    .brand h2 {
      margin: 0;
      font-size: 18px;
      line-height: 1.3;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ë¡œê·¸ì¸ ë°•ìŠ¤ */
    .login-box {
      max-width: 400px;
      margin: 0 auto;
      padding: 32px;
      border-radius: var(--radius);
      background: #ffffff;
      box-shadow: var(--shadow-lg);
    }

    .login-box h3 {
      margin: 0 0 24px;
      font-size: 20px;
      text-align: center;
      color: var(--gray-800);
    }

    .login-box h3::before {
      content: "ğŸ” ";
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--gray-700);
      font-size: 14px;
    }

    .hint {
      font-size: 12px;
      font-weight: 400;
      color: var(--gray-500);
      margin-left: 4px;
    }

    input,
    select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 2px solid var(--gray-200);
      font-size: 15px;
      background: var(--gray-50);
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(124, 58, 237, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 2px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
    }

    .btn-warning.active {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      animation: pulse 2s infinite;
    }

    

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #ff5a5a 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
      }

      50% {
        box-shadow: 0 4px 24px rgba(245, 158, 11, 0.6);
      }
    }

    .login-msg {
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
    }

    .login-msg.error {
      color: var(--danger);
      font-weight: 600;
    }

    /* ì•± ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .app-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-lg);
    }

    /* ì‚¬ìš©ì ì •ë³´ ë°” */
    .user-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 14px 16px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      background: #fff;
      border: 1px solid var(--gray-200);
    }

    .user-badge.user-name {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      border: none;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }

    .status-badge.success {
      background: var(--success-light);
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .status-badge.pending {
      background: var(--warning-light);
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    /* ì•ˆë‚´ ë¬¸êµ¬ ë°•ìŠ¤ */
    .notice {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #fcd34d;
      border-radius: 14px;
      padding: 16px 18px;
      margin-bottom: 20px;
    }

    .notice-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--gray-800);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notice-title::before {
      content: "ğŸ’¡";
    }

    .notice-text {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.5;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ */
    .action-area {
      margin-bottom: 20px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .mode-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: var(--gray-50);
      border-radius: 10px;
      font-size: 13px;
    }

    .mode-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
    }

    .mode-dot.leave {
      background: var(--warning);
    }

    /* ë¶„ê¸° ì„ íƒ */
    .period-select-wrapper {
      margin-bottom: 20px;
    }

    .period-select-wrapper label {
      margin-bottom: 8px;
    }

    /* ì§‘ê³„ ì¹´ë“œ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 14px;
      padding: 16px 12px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .stat-card .icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .stat-card .label {
      color: var(--gray-500);
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 22px;
      font-weight: 900;
      color: var(--gray-800);
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none;
    }

    .stat-card.highlight .label,
    .stat-card.highlight .value {
      color: #fff;
    }

    /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .progress-section {
      margin-bottom: 20px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--gray-700);
    }

    .progress-bar-container {
      height: 24px;
      background: var(--gray-100);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      border-radius: 12px;
      transition: width 0.5s ease;
      background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
    }

    .progress-bar.success {
      background: linear-gradient(90deg, #34d399 0%, var(--success) 100%);
    }

    .progress-threshold {
      position: absolute;
      left: 85%;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--danger);
      opacity: 0.7;
    }

    .progress-threshold::after {
      content: "85%";
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: var(--danger);
    }

    .progress-text {
      text-align: center;
      margin-top: 8px;
      font-size: 13px;
      color: var(--gray-600);
    }

    .progress-text b {
      color: var(--primary);
    }

    .progress-text.success b {
      color: var(--success);
    }

    /* ìƒíƒœ ë°°ì§€ */
    .result-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .result-badge.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border: 2px solid #34d399;
    }

    .result-badge.pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border: 2px solid #fbbf24;
    }

    /* ìº˜ë¦°ë” */
    .calendar-section {
      margin-top: 24px;
    }

    .calendar-section-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--gray-800);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .calendar-section-title::before {
      content: "ğŸ“…";
    }

    .calendar-card {
      position: relative;
      border-radius: 18px;
      padding: 20px;
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .calendar-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("grape.png") center/contain no-repeat;
      opacity: 0.3;
      pointer-events: none;
    }

    /* ìš”ì¼ í—¤ë” */
    .weekday-header {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }

    .weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-500);
      padding: 8px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
    }

    .calendar-grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    .cell {
      border-radius: 14px;
      padding: 14px 8px;
      text-align: center;
      background: rgba(255, 255, 255, .95);
      border: 2px solid var(--gray-200);
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      position: relative;
    }

    .cell:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }

    .cell .date {
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .cell .status-icon {
      font-size: 18px;
    }

    
    .status-text{
      font-size: 11px;
      margin-top: 6px;
      opacity: .95;
      line-height: 1.1;
    }

    .status-pill{
      display: inline-block;
      margin-left: 8px;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--gray-200);
      background: rgba(255,255,255,.8);
      vertical-align: middle;
    }
    .status-pill.pending{ border-color: var(--warning); }
    .status-pill.approved{ border-color: var(--success); }
    .status-pill.rejected{ border-color: var(--danger); }
    .status-pill.leave{ border-color: var(--gray-400); }
.cell.done {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      border-color: var(--primary-dark);
    }

    .cell.leave {
      background: linear-gradient(135deg, var(--gray-200) 0%, var(--gray-300) 100%);
      color: var(--gray-600);
      border-color: var(--gray-400);
    }

    .cell.pending {
      background: linear-gradient(135deg, var(--warning) 0%, #ffb020 100%);
      color: #1f2937;
      border-color: var(--warning);
    }

    .cell.rejected {
      background: linear-gradient(135deg, var(--danger) 0%, #ff5a5a 100%);
      color: #fff;
      border-color: var(--danger);
    }

    .cell.selected {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .cell.today {
      border-color: var(--warning);
      border-width: 3px;
    }

    .cell.today::after {
      content: "ì˜¤ëŠ˜";
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      font-weight: 700;
      background: var(--warning);
      color: #fff;
      padding: 2px 6px;
      border-radius: 8px;
    }

    /* ìº˜ë¦°ë” ë²”ë¡€ */
    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-200);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--gray-600);
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 6px;
    }

    .legend-dot.done {
      background: var(--primary);
    }

    .legend-dot.leave {
      background: var(--gray-300);
    }

    .legend-dot.pending {
      background: #fff;
      border: 2px solid var(--gray-300);
    }

    @media (max-width: 680px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 14px;
      }

      .calendar-grid,
      .weekday-header {
        gap: 6px;
      }

      .cell {
        padding: 10px 6px;
      }

      .brand h2 {
        font-size: 15px;
      }

      .action-buttons {
        grid-template-columns: 1fr;
      }

      .stat-card .value {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
<div class="container">
<!-- âœ… ë¡œê·¸ì¸ ì „ ì œëª© -->
<div class="brand" id="brandLogin">
<img alt="logo" src="logo.png"/>
<h2>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸<br/>í…€ë¸”ëŸ¬ ë¯¸ì…˜</h2>
</div>
<!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
<div class="login-box" id="loginBox">
<h3>ë¡œê·¸ì¸</h3>
<div class="form-group">
<label>ì˜ë¬¸ ì´ë¦„</label>
<select id="userSelect"></select>
</div>
<div class="form-group">
<label>PIN 4ìë¦¬ <span class="hint">(íœ´ëŒ€ë²ˆí˜¸ ë’·4ìë¦¬)</span></label>
<input id="pin" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" type="password"/>
</div>
<button class="btn btn-primary" id="loginBtn">
<span>ğŸš€</span> ë¡œê·¸ì¸
      </button>
<p class="login-msg" id="loginMsg"></p>
</div>
<!-- âœ… ë¡œê·¸ì¸ í›„ í™”ë©´ -->
<div id="app" style="display:none">
<!-- âœ… ë¡œê·¸ì¸ í›„ ì œëª© -->
<div class="brand" id="brandApp">
<img alt="logo" src="logo.png"/>
<h2>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸<br/>í…€ë¸”ëŸ¬ ë¯¸ì…˜</h2>
</div>
<div class="app-container">
<!-- ì‚¬ìš©ì ì •ë³´ ë°” -->
<div class="user-bar">
<span class="user-badge user-name" id="who"></span>
<span class="user-badge">ğŸ“… ì˜¤ëŠ˜: <b id="todayLabel"></b></span>
<span class="status-badge pending" id="statusBadge">â³ ì§„í–‰ ì¤‘</span>
</div>
<!-- âœ… ì•ˆë‚´ ë¬¸êµ¬ -->
<div class="notice">
<div class="notice-title">ë¯¸ì…˜ ì„±ê³µ ì¡°ê±´</div>
<div class="notice-text">
            Working day ê¸°ì¤€ <b>ì¸ì¦ìƒ· ì œì¶œ 85% ì´ìƒ</b> ì‹œ ë¯¸ì…˜ ì„±ê³µ!<br/>
            ì‚¬ì§„ì€ ì´ í˜ì´ì§€ì—ì„œ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ìš©ëŸ‰ì´ ì¶•ì†Œë˜ì–´ ì €ì¥ë˜ë©°, ì œì¶œ í›„ ê´€ë¦¬ìê°€ ê²€ìˆ˜í•©ë‹ˆë‹¤.<br/>
            ê²€ìˆ˜ ê²°ê³¼ì— ë”°ë¼ <b>ë¶€ì ê²© ì²˜ë¦¬</b>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
</div>
<!-- ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ -->
<div class="action-area">
<div class="action-buttons">
<button class="btn btn-success" id="submitBtn">
<span>â˜•</span> í…€ë¸”ëŸ¬ ì¸ì¦ ì™„ë£Œ!
            </button>
<button class="btn btn-warning" id="leaveBtn">
<span>ğŸ–ï¸</span> ì—°ì°¨ í‘œì‹œ
            </button>
</div>
<div class="mode-indicator">
<div class="mode-dot" id="modeDot"></div>
<span>í˜„ì¬ ëª¨ë“œ: <b id="modeText">ì¸ì¦ ì œì¶œ</b></span>
<span style="color: var(--gray-400);">|</span>
<span style="font-size: 12px; color: var(--gray-500);">ë‚ ì§œë¥¼ ì„ íƒí•œ ë’¤ ì‚¬ì§„ì„ ì œì¶œí•˜ì„¸ìš” (ì—°ì°¨ ëª¨ë“œì—ì„œëŠ” ë‚ ì§œë¥¼ í´ë¦­í•´ í† ê¸€)</span>
</div>
</div>
<!-- ğŸ“· ì‚¬ì§„ ì œì¶œ íŒ¨ë„ (ì¸ì¦ ì œì¶œ ëª¨ë“œì—ì„œ ì‚¬ìš©) -->
<div class="notice" id="photoPanel" style="margin-top: 14px;">
<div class="notice-title">ğŸ“· ì¸ì¦ìƒ· ì œì¶œ</div>
<div class="notice-text" style="margin-top: 8px;">
            ì„ íƒí•œ ë‚ ì§œ: <b id="selectedDateLabel">-</b> <span class="status-pill" id="selectedStatusPill">-</span><br/>
            ì‚¬ì§„ì„ ì„ íƒí•œ ë’¤ <b>ì œì¶œ</b>í•˜ë©´ ìë™ìœ¼ë¡œ ìš©ëŸ‰ì„ ì¤„ì—¬ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
          </div>
<div style="margin-top: 10px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
<!-- ì•¨ë²”/ì¹´ë©”ë¼ ì„ íƒ: ì•¨ë²” ì—…ë¡œë“œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤ -->
<input accept="image/*" id="photoInputAlbum" type="file" style="display:none;" />
<input accept="image/*" id="photoInputCamera" type="file" capture="environment" style="display:none;" />
<button class="btn btn-outline" id="pickAlbumBtn" type="button"><span>ğŸ–¼ï¸</span> ì•¨ë²”ì—ì„œ ì„ íƒ</button>
<button class="btn btn-outline" id="pickCameraBtn" type="button"><span>ğŸ“·</span> ì¹´ë©”ë¼ë¡œ ì´¬ì˜</button>

<button class="btn btn-success" id="uploadBtn">
<span>â¬†ï¸</span> ì œì¶œí•˜ê¸°
            </button>
<span id="sizeInfo" style="font-size: 12px; color: var(--gray-600);"></span>
</div>
<div style="margin-top: 10px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
<img id="photoPreview" style="max-width: 160px; border-radius: 12px; display: none; border: 1px solid var(--gray-200);"/>
<div style="font-size: 12px; color: var(--gray-600); line-height: 1.45;">
              â€¢ íƒ€ì„ìŠ¤íƒ¬í”„(ë‚ ì§œ/ì‹œê°„)ì™€ í…€ë¸”ëŸ¬ê°€ ì˜ ë³´ì´ê²Œ ì´¬ì˜í•´ì£¼ì„¸ìš”.<br/>
              â€¢ ì œì¶œí•˜ë©´ ìº˜ë¦°ë”ì— <b>ğŸ•’(ê²€ìˆ˜ì¤‘)</b> í‘œì‹œê°€ ëœ¹ë‹ˆë‹¤.
            </div>
</div>
<p id="uploadMsg" style="margin:10px 0 0; font-size:13px;"></p>
</div>
<!-- âœ… ì œì¶œ ì „ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
<div style="max-width:420px; margin:10vh auto; background:#fff; border-radius:16px; padding:16px;">
<div style="font-weight:800; font-size:16px;">ì œì¶œ ì „ í™•ì¸</div>
<div style="margin-top:10px; font-size:13px; color:#444; line-height:1.5;">
              ì•„ë˜ í•­ëª©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”. ì œì¶œ í›„ ê´€ë¦¬ìê°€ ê²€ìˆ˜í•˜ë©°,<br/>
              ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì¸ì¦ìƒ·ì€ <b>ë¶€ì ê²© ì²˜ë¦¬</b>ë  ìˆ˜ ìˆì–´ìš”.
            </div>
<ul style="margin:12px 0; padding-left:18px; font-size:13px; color:#333;">
<li>í…€ë¸”ëŸ¬(ë˜ëŠ” ë¦¬ìœ ì €ë¸” ì»µ) ì‚¬ìš©ì´ ì‚¬ì§„ì— ë³´ì…ë‹ˆë‹¤</li>
<li>íƒ€ì„ìŠ¤íƒ¬í”„(ë‚ ì§œ/ì‹œê°„)ê°€ ì½í™ë‹ˆë‹¤</li>
<li>ì„ íƒí•œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì œì¶œí•©ë‹ˆë‹¤</li>
</ul>
<label style="display:flex; gap:8px; align-items:center; font-size:13px; color:#333;">
<input id="confirmCheck" type="checkbox"/>
              í™•ì¸í–ˆìŠµë‹ˆë‹¤
            </label>
<div style="display:flex; gap:10px; margin-top:14px;">
<button class="btn" id="confirmCancel" style="flex:1;">ì·¨ì†Œ</button>
<button class="btn btn-success" disabled="" id="confirmOk" style="flex:1;">ì œì¶œ</button>
</div>
</div>
</div>
<!-- ë¶„ê¸° ì„ íƒ -->
<div class="period-select-wrapper">
<label>ğŸ“Š ë¶„ê¸° ì„ íƒ</label>
<select id="periodSelect"></select>
</div>
<!-- âœ… ë¶„ê¸°ë³„ ì§‘ê³„ -->
<div class="stats-grid">
<div class="stat-card">
<div class="icon">ğŸ“†</div>
<div class="label">ì´ Working Day</div>
<div class="value" id="statWD">-</div>
</div>
<div class="stat-card">
<div class="icon">ğŸ¯</div>
<div class="label">ëª©í‘œ ì¼ìˆ˜</div>
<div class="value" id="statTarget">-</div>
</div>
<div class="stat-card">
<div class="icon">âœ…</div>
<div class="label">ì„±ê³µ ì¼ìˆ˜</div>
<div class="value" id="statDone">-</div>
</div>
<div class="stat-card highlight">
<div class="icon">ğŸ“ˆ</div>
<div class="label">ë‹¬ì„±ë¥ </div>
<div class="value" id="statRate">-</div>
</div>
</div>
<!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
<div class="progress-section">
<div class="progress-header">
<span class="progress-title">ğŸ† ë¯¸ì…˜ ì§„í–‰ë¥ </span>
<span class="result-badge pending" id="passBadge">â³ ì§„í–‰ ì¤‘</span>
</div>
<div class="progress-bar-container">
<div class="progress-bar" id="progressBar" style="width: 0%"></div>
<div class="progress-threshold"></div>
</div>
<p class="progress-text" id="remainText"></p>
</div>
<!-- ìº˜ë¦°ë” -->
<div class="calendar-section">
<div class="calendar-section-title">ë¯¸ì…˜ ìº˜ë¦°ë”</div>
<div class="calendar-card">
<div class="weekday-header">
<div class="weekday">ì›”</div>
<div class="weekday">í™”</div>
<div class="weekday">ìˆ˜</div>
<div class="weekday">ëª©</div>
<div class="weekday">ê¸ˆ</div>
</div>
<div class="calendar-grid" id="grid"></div>
<div class="calendar-legend">
<div class="legend-item">
<div class="legend-dot done"></div>
<span>ì¸ì¦ ì™„ë£Œ</span>
</div>
<div class="legend-item">
<div class="legend-dot leave"></div>
<span>ì—°ì°¨</span>
</div>
<div class="legend-item">
<div class="legend-dot pending"></div>
<span>ë¯¸ì œì¶œ</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
    /**********************
     * Firebase Config
     **********************/
    const firebaseConfig = {
  apiKey: "AIzaSyDP1vuX-HFIFf9t6Mh5sBgmCwuoT8u9pOg",
  authDomain: "tumblermission.firebaseapp.com",
  databaseURL: "https://tumblermission-default-rtdb.firebaseio.com",
  projectId: "tumblermission",
  storageBucket: "tumblermission.firebasestorage.app",
  messagingSenderId: "553319063400",
  appId: "1:553319063400:web:323116933c7fbe592dc0dd"
};

// âœ… Firebase ì´ˆê¸°í™” (ì„¤ì • ë¯¸ì…ë ¥/ì˜¤ë¥˜ ì‹œ í™”ë©´ì— ì›ì¸ì„ í‘œì‹œ)
function configLooksPlaceholder(cfg) {
  const s = JSON.stringify(cfg || {});
  return /YOUR_API_KEY|YOUR_PROJECT|YOUR_PROJECT_ID/.test(s);
}
function showInitError(message, detail) {
  const el = document.getElementById("loginMsg");
  if (el) {
    el.className = "login-msg error";
    el.innerHTML = `<span class="error">${message}</span>${detail ? `<br><small style="opacity:.9">${detail}</small>` : ""}`;
  }
}

let db, storage, auth;
try {
  if (configLooksPlaceholder(firebaseConfig)) {
    throw new Error("Firebase ì„¤ì •(firebaseConfig)ì´ ì•„ì§ 'YOUR_...' ìƒíƒœì…ë‹ˆë‹¤.");
  }
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  storage = firebase.storage();
  auth = firebase.auth();
} catch (e) {
  console.error("Firebase init failed:", e);
  showInitError(
    "Firebase ì„¤ì • ì˜¤ë¥˜ë¡œ ë¡œê·¸ì¸ í™”ë©´ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.",
    "index_fixed.htmlì˜ firebaseConfig(apiKey/authDomain/projectId/storageBucket/databaseURL)ë¥¼ Firebase ì½˜ì†” ê°’ìœ¼ë¡œ êµì²´í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
  );
  // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ë‹¨ (firebaseê°€ ì—†ìœ¼ë©´ ì•„ë˜ ë¡œì§ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
  throw e;
}

// âœ… Storage Rulesì—ì„œ request.auth != null ì¡°ê±´ì„ ì“°ëŠ” ê²½ìš°(ê¶Œì¥),
    //    ì•„ë˜ ìµëª… ë¡œê·¸ì¸(Anonymous Auth)ì´ í•„ìš”í•©ë‹ˆë‹¤.
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      const cred = await auth.signInAnonymously();
      return cred.user;
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ë¦¬ ë¡œê·¸ì¸ ì‹œë„ (ë„¤íŠ¸ì›Œí¬ ìƒí™©ì— ë”°ë¼ ì§€ì—°ë  ìˆ˜ ìˆìŒ)
    ensureAnonAuth().catch(console.error);


    /**********************
     * ë¶„ê¸° ëª©ë¡
     **********************/
    const PERIODS = [
      { id: "2026Q1", start: "2026-01-12", end: "2026-03-31", label: "2026Q1 (01/12~03/31)" },
      { id: "2026Q2", start: "2026-04-01", end: "2026-06-30", label: "2026Q2 (04/01~06/30)" },
      { id: "2026Q3", start: "2026-07-01", end: "2026-09-30", label: "2026Q3 (07/01~09/30)" },
      { id: "2026Q4", start: "2026-10-01", end: "2026-11-15", label: "2026Q4 (10/01~11/15)" }
    ];

    /**********************
     * ê³µíœ´ì¼/íœ´ë¬´ì¼
     **********************/
    const HOLIDAYS_2026 = new Set([
      "2026-02-16", "2026-02-17", "2026-02-18",
      "2026-03-02",
      "2026-05-01", "2026-05-05", "2026-05-25",
      "2026-06-03",
      "2026-08-17",
      "2026-09-24", "2026-09-25",
      "2026-10-05", "2026-10-09",
    ]);

    /**********************
     * DOM
     **********************/
    const brandLogin = document.getElementById("brandLogin");
    const userSelect = document.getElementById("userSelect");
    const pinInput = document.getElementById("pin");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const loginBox = document.getElementById("loginBox");
    const app = document.getElementById("app");

    const who = document.getElementById("who");
    const todayLabel = document.getElementById("todayLabel");
    const grid = document.getElementById("grid");

    const submitBtn = document.getElementById("submitBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const modeText = document.getElementById("modeText");
    const modeDot = document.getElementById("modeDot");
    const periodSelect = document.getElementById("periodSelect");

    const statWD = document.getElementById("statWD");
    const statTarget = document.getElementById("statTarget");
    const statDone = document.getElementById("statDone");
    const statRate = document.getElementById("statRate");
    const passBadge = document.getElementById("passBadge");
    const statusBadge = document.getElementById("statusBadge");
    const progressBar = document.getElementById("progressBar");

    // ğŸ“· ì‚¬ì§„ ì œì¶œ UI
    const photoPanel = document.getElementById("photoPanel");
    const selectedDateLabel = document.getElementById("selectedDateLabel");
    const selectedStatusPill = document.getElementById("selectedStatusPill");
    const photoInputAlbum = document.getElementById("photoInputAlbum");
    const photoInputCamera = document.getElementById("photoInputCamera");
    const pickAlbumBtn = document.getElementById("pickAlbumBtn");
    const pickCameraBtn = document.getElementById("pickCameraBtn");
    const photoPreview = document.getElementById("photoPreview");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadMsg = document.getElementById("uploadMsg");
    const sizeInfo = document.getElementById("sizeInfo");
    // âœ… í™•ì¸ ëª¨ë‹¬
    const confirmModal = document.getElementById("confirmModal");
    const confirmCheck = document.getElementById("confirmCheck");
    const confirmCancel = document.getElementById("confirmCancel");
    const confirmOk = document.getElementById("confirmOk");


    /**********************
     * ìƒíƒœ
     **********************/
    let currentUser = null;
    let submissions = {};
    let leaves = {};
    let leaveMode = false;

    let selectedDate = null; // YYYY-MM-DD
    let selectedFile = null; // File


    /**********************
     * ìœ í‹¸
     **********************/
    function todayYmd() {
      const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
      return d.toISOString().slice(0, 10);
    }

    function normalizeSubmission(v) {
      // ê³¼ê±° ë°ì´í„°: trueë©´ ì œì¶œ(ìŠ¹ì¸)ë¡œ ê°„ì£¼
      if (v === true) return { status: "approved" };
      if (!v) return null;
      if (typeof v === "object") return { status: v.status || "pending", ...v };
      return null;
    }

    function formatBytes(bytes) {
      const units = ["B", "KB", "MB", "GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    async function compressImage(file, { maxSize = 1280, quality = 0.82, mimeType = "image/jpeg" } = {}) {
      const img = new Image();
      const url = URL.createObjectURL(file);

      await new Promise((res, rej) => {
        img.onload = res;
        img.onerror = rej;
        img.src = url;
      });

      const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(img, 0, 0, w, h);

      URL.revokeObjectURL(url);

      const blob = await new Promise((res) => canvas.toBlob(res, mimeType, quality));
      if (!blob) throw new Error("ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨");
      return blob;
    }

    function setUploadMessage(text, kind = "info") {
      uploadMsg.textContent = text || "";
      if (!text) {
        uploadMsg.style.color = "inherit";
        return;
      }
      uploadMsg.style.color =
        kind === "success" ? "var(--success)" :
        kind === "danger" ? "var(--danger)" :
        kind === "warning" ? "var(--warning)" :
        "var(--gray-700)";
    }

    function openConfirmModal() {
      if (!confirmModal) return;
      confirmCheck.checked = false;
      confirmOk.disabled = true;
      confirmModal.style.display = "block";
    }

    function closeConfirmModal() {
      if (!confirmModal) return;
      confirmModal.style.display = "none";
    }

    async function uploadForSelectedDate() {
      if (!currentUser) return;
      try { await ensureAnonAuth(); } catch (e) { console.error(e); setUploadMessage("ì¸ì¦ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë„¤íŠ¸ì›Œí¬/ë„ë©”ì¸/Anonymous Auth ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "danger"); return; }
      if (leaveMode) {
        setUploadMessage("ì—°ì°¨ í‘œì‹œ ëª¨ë“œì—ì„œëŠ” ì œì¶œí•  ìˆ˜ ì—†ì–´ìš”. ì¸ì¦ ì œì¶œ ëª¨ë“œë¡œ ì „í™˜í•´ ì£¼ì„¸ìš”.", "warning");
        return;
      }
      if (!selectedDate) {
        setUploadMessage("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
        return;
      }
      if (!selectedFile) {
        setUploadMessage("ì‚¬ì§„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
        return;
      }
      if (!isWorkingDay(selectedDate)) {
        setUploadMessage("ì„ íƒí•œ ë‚ ì§œëŠ” Working dayê°€ ì•„ë‹ˆë¼ ì œì¶œí•  ìˆ˜ ì—†ì–´ìš”.", "danger");
        return;
      }
      if (leaves?.[selectedDate]) {
        setUploadMessage("ì„ íƒí•œ ë‚ ì§œëŠ” ì—°ì°¨ë¡œ í‘œì‹œë˜ì–´ ìˆì–´ ì œì¶œí•  ìˆ˜ ì—†ì–´ìš”.", "danger");
        return;
      }

      uploadBtn.disabled = true;
      setUploadMessage("ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...", "info");

      // âœ… ì—…ë¡œë“œ ì§ì „ì— auth ë³´ì¥
      await ensureAnonAuth();

      try {
        const originalBytes = selectedFile.size;

        // ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´(ì¬ì œì¶œ) ì´ì „ storage íŒŒì¼ ì‚­ì œ ì‹œë„
        const existing = normalizeSubmission(submissions?.[selectedDate]);
        if (existing?.storagePath) {
          try { await storage.ref(existing.storagePath).delete(); } catch (e) { /* ë¬´ì‹œ */ }
        }

        const compressedBlob = await compressImage(selectedFile, { maxSize: 1280, quality: 0.82, mimeType: "image/jpeg" });
        const compressedBytes = compressedBlob.size;

        if (sizeInfo) {
          sizeInfo.textContent = `ì›ë³¸ ${formatBytes(originalBytes)} â†’ ì••ì¶• ${formatBytes(compressedBytes)}`;
        }

        const ymd = selectedDate;
        const month = ymd.slice(0, 7);

        const baseName = (selectedFile.name || "photo")
          .replace(/[^\w.\-]+/g, "_")
          .replace(/\.[^.]+$/, "");
        const safeName = `${baseName}.jpg`;
        const path = `tumblermission/${month}/${currentUser}/${ymd}/${Date.now()}_${safeName}`;

        const ref = storage.ref(path);
        const snap = await ref.put(compressedBlob, {
          contentType: "image/jpeg",
          customMetadata: { user: currentUser, ymd, originalName: selectedFile.name || "" }
        });

        const downloadURL = await snap.ref.getDownloadURL();

        // ì œì¶œ ê¸°ë¡ (ê²€ìˆ˜ì¤‘)
        const submission = {
          status: "pending",
          url: downloadURL,
          storagePath: path,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP,
          originalName: selectedFile.name || "",
          sizeBytes: compressedBytes,
          mimeType: "image/jpeg"
        };

        // users/{user}/submissions/{ymd}
        await db.ref(`users/${currentUser}/submissions/${ymd}`).set(submission);

        // ê´€ë¦¬ì ì›”ë³„ ì¸ë±ìŠ¤: photoIndex/{YYYY-MM}/{YYYY-MM-DD}/{user}
        await db.ref(`photoIndex/${month}/${ymd}/${currentUser}`).set({
          user: currentUser,
          ymd,
          status: "pending",
          url: downloadURL,
          storagePath: path,
          uploadedAt: firebase.database.ServerValue.TIMESTAMP,
          sizeBytes: compressedBytes,
          originalName: selectedFile.name || ""
        });

        // UI reset
        if (photoInputAlbum) photoInputAlbum.value = "";
        if (photoInputCamera) photoInputCamera.value = "";
        selectedFile = null;
        if (photoPreview) photoPreview.style.display = "none";

        await loadUserData();
        render();

        setUploadMessage("âœ… ì œì¶œ ì™„ë£Œ! (ê²€ìˆ˜ì¤‘) â€” ê²€ìˆ˜ ê²°ê³¼ì— ë”°ë¼ ë¶€ì ê²© ì²˜ë¦¬ë  ìˆ˜ ìˆì–´ìš”.", "success");
      } catch (e) {
        console.error(e);
        const code = e?.code || "";
        const rawMsg = e?.message || "";
        let friendly = "ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´ìš”.";

        if (code.includes("storage/unauthorized") || code.includes("storage/unauthenticated")) {
          friendly = "ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ì–´ìš”. Storage Rulesì—ì„œ ì—…ë¡œë“œ ê²½ë¡œ(tumblermission/...)ë¥¼ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.";
        } else if (code.includes("storage/canceled")) {
          friendly = "ì—…ë¡œë“œê°€ ì·¨ì†Œëì–´ìš”.";
        } else if (code.includes("storage/retry-limit-exceeded")) {
          friendly = "ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•´ ì—…ë¡œë“œê°€ ë°˜ë³µ ì‹¤íŒ¨í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        } else if (code.includes("auth/network-request-failed")) {
          friendly = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸ì¦/ì—…ë¡œë“œê°€ ì‹¤íŒ¨í–ˆì–´ìš”. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        } else if (rawMsg && rawMsg.toLowerCase().includes("cross-origin")) {
          friendly = "í˜¸ìŠ¤íŒ…/CORS ì´ìŠˆë¡œ ì—…ë¡œë“œê°€ ë§‰í˜”ì–´ìš”. GitHub Pages ë„ë©”ì¸ì´ Authorized domainsì— ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.";
        } else if (rawMsg && (rawMsg.toLowerCase().includes("heic") || rawMsg.toLowerCase().includes("decode") || rawMsg.toLowerCase().includes("image"))) {
          friendly = "ì„ íƒí•œ ì‚¬ì§„ í˜•ì‹ì„ ë¸Œë¼ìš°ì €ê°€ ì½ì§€ ëª»í•´ìš”(ì˜ˆ: HEIC). ì‚¬ì§„ì„ JPEG/PNGë¡œ ë³€í™˜ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }

        const detail = [code ? `ì½”ë“œ: ${code}` : "", rawMsg ? `ë©”ì‹œì§€: ${rawMsg}` : ""].filter(Boolean).join(" / ");
        setUploadMessage(`${friendly}${detail ? `
(${detail})` : ""}`, "danger");
      } finally {
        uploadBtn.disabled = false;
      }
    }



    function isWeekend(ymd) {
      const day = new Date(ymd + "T00:00:00+09:00").getDay();
      return day === 0 || day === 6;
    }

    function isLaborDay(ymd) {
      return ymd.endsWith("-05-01");
    }

    function isWorkingDay(ymd) {
      if (isWeekend(ymd)) return false;
      if (HOLIDAYS_2026.has(ymd)) return false;
      if (isLaborDay(ymd)) return false;
      return true;
    }

    function ymdFromKSTDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function dateRange(startYmd, endYmd) {
      const out = [];
      let d = new Date(startYmd + "T00:00:00+09:00");
      const e = new Date(endYmd + "T00:00:00+09:00");
      while (d <= e) {
        out.push(ymdFromKSTDate(d));
        d.setDate(d.getDate() + 1);
      }
      return out;
    }

    function mondayBasedIndex(ymd) {
      const d = new Date(ymd + "T00:00:00+09:00").getDay();
      const map = { 1: 0, 2: 1, 3: 2, 4: 3, 5: 4 };
      return map[d];
    }

    /**********************
     * ë°ì´í„° ë¡œë“œ
     **********************/
    async function loadEmployees() {
  try {
    const snap = await db.ref("employees").get();
    userSelect.innerHTML = "";
    if (!snap.exists()) {
      loginMsg.innerHTML = `<span class="error">ì§ì› ëª©ë¡(employees)ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. (DBì— employees/{ì§ì›ID} ë“±ë¡ í•„ìš”)</span>`;
      loginMsg.className = "login-msg error";
      return;
    }

    snap.forEach(c => {
      const v = c.val();
      if (v && v.active) {
        const o = document.createElement("option");
        o.value = c.key;
        o.textContent = c.key;
        userSelect.appendChild(o);
      }
    });

    if (!userSelect.value && userSelect.options.length > 0) {
      userSelect.value = userSelect.options[0].value;
    }
  } catch (e) {
    console.error("loadEmployees failed:", e);
    loginMsg.innerHTML = `<span class="error">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</span><br><small>${(e && e.code) ? e.code : ""} ${(e && e.message) ? e.message : e}</small>`;
    loginMsg.className = "login-msg error";
  }
    }

    async function loadUserData() {
  try {
    submissions = (await db.ref(`users/${currentUser}/submissions`).get()).val() || {};
    leaves = (await db.ref(`users/${currentUser}/leaves`).get()).val() || {};
  } catch (e) {
    console.error("loadUserData failed:", e);
    throw e;
  }
}

    /**********************
     * ë¡œê·¸ì¸
     **********************/
    async function login() {
      const u = userSelect.value;
      const p = pinInput.value;

      if (!u) {
        loginMsg.innerHTML = `<span class="error">ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</span>`;
        loginMsg.className = "login-msg error";
        return;
      }

      const snap = await db.ref(`employees/${u}`).get();
      if (!snap.exists()) {
        loginMsg.innerHTML = `<span class="error">ì§ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        loginMsg.className = "login-msg error";
        return;
      }

      const emp = snap.val();
      if (!emp.active) {
        loginMsg.innerHTML = `<span class="error">ë¹„í™œì„± ê³„ì •ì…ë‹ˆë‹¤.</span>`;
        loginMsg.className = "login-msg error";
        return;
      }

      if (String(emp.pin) !== String(p)) {
        loginMsg.innerHTML = `<span class="error">PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤.</span>`;
        loginMsg.className = "login-msg error";
        return;
      }

      currentUser = u;
// âœ… Storage ì—…ë¡œë“œ ê¶Œí•œì„ ìœ„í•´ ìµëª… ë¡œê·¸ì¸ ë³´ì¥
try { await ensureAnonAuth(); } catch (e) { console.error("anon auth failed:", e); }

try {
  await loadUserData();
} catch (e) {
  loginMsg.innerHTML = `<span class="error">ë¡œê·¸ì¸ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´ìš”.</span><br><small>${(e && e.code) ? e.code : ""} ${(e && e.message) ? e.message : e}</small>`;
  loginMsg.className = "login-msg error";
  return;
}

brandLogin.style.display = "none";
      loginBox.style.display = "none";
      app.style.display = "block";

      who.textContent = `ğŸ‘¤ ${u}`;
      todayLabel.textContent = todayYmd();

      // ê¸°ë³¸ ì„ íƒ ë‚ ì§œ(ì˜¤ëŠ˜ ìš°ì„ )
      selectedDate = todayYmd();
      if (selectedDateLabel) selectedDateLabel.textContent = selectedDate;
render();
    }

    loginBtn.onclick = login;
    pinInput.addEventListener("keydown", e => {
      if (e.key === "Enter") login();
    });

    /**********************
     * ëª¨ë“œ
     **********************/
    function setModeLeave(on) {
      leaveMode = on;
      modeText.textContent = leaveMode ? "ì—°ì°¨ í‘œì‹œ" : "ì¸ì¦ ì œì¶œ";

      if (leaveMode) {
        modeDot.classList.add("leave");
        leaveBtn.classList.add("active");
        submitBtn.classList.remove("active");
        if (photoPanel) photoPanel.style.display = "none";
      } else {
        modeDot.classList.remove("leave");
        leaveBtn.classList.remove("active");
        if (photoPanel) photoPanel.style.display = "block";
      }
    }

    submitBtn.onclick = () => setModeLeave(false);
    leaveBtn.onclick = () => setModeLeave(!leaveMode);

    /**********************
     * ì‚¬ì§„ ì œì¶œ UI ì´ë²¤íŠ¸
     **********************/
    if (photoInputAlbum || photoInputCamera) {
      
      function handlePickedFile(f) {
        selectedFile = f;
        setUploadMessage("");
        if (!f) {
          if (photoPreview) photoPreview.style.display = "none";
          if (sizeInfo) sizeInfo.textContent = "";
          return;
        }
        if (sizeInfo) sizeInfo.textContent = `ì›ë³¸ ${formatBytes(f.size)} (ì œì¶œ ì‹œ ìë™ ì••ì¶•)`;

        try {
          const url = URL.createObjectURL(f);
          if (photoPreview) {
            photoPreview.src = url;
            photoPreview.style.display = "block";
            photoPreview.onload = () => URL.revokeObjectURL(url);
          }
        } catch (e) {
          console.error(e);
        }
      }

      function bindPhotoInput(inputEl) {
        if (!inputEl) return;
        inputEl.addEventListener("change", () => {
          const f = inputEl.files?.[0] || null;
          handlePickedFile(f);
          // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ë•Œ changeê°€ ë‹¤ì‹œ ë°œìƒí•˜ë„ë¡ ì´ˆê¸°í™”
          inputEl.value = "";
        });
      }

      bindPhotoInput(photoInputAlbum);
      bindPhotoInput(photoInputCamera);

      pickAlbumBtn?.addEventListener("click", () => photoInputAlbum?.click());
      pickCameraBtn?.addEventListener("click", () => photoInputCamera?.click());
    }

    if (confirmCheck) {
      confirmCheck.addEventListener("change", () => {
        confirmOk.disabled = !confirmCheck.checked;
      });
    }
    if (confirmCancel) confirmCancel.onclick = closeConfirmModal;

    if (uploadBtn) {
      uploadBtn.onclick = () => {
        if (!currentUser) return;
        if (leaveMode) {
          setUploadMessage("ì—°ì°¨ í‘œì‹œ ëª¨ë“œì—ì„œëŠ” ì œì¶œí•  ìˆ˜ ì—†ì–´ìš”. ì¸ì¦ ì œì¶œ ëª¨ë“œë¡œ ì „í™˜í•´ ì£¼ì„¸ìš”.", "warning");
          return;
        }
        if (!selectedDate) {
          setUploadMessage("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
          return;
        }
        if (!selectedFile) {
          setUploadMessage("ì‚¬ì§„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
          return;
        }
        openConfirmModal();
      };
    }

    if (confirmOk) {
      confirmOk.onclick = async () => {
        closeConfirmModal();
        await uploadForSelectedDate();
      };
    }


    /**********************
     * ë¶„ê¸° ì˜µì…˜
     **********************/
    function initPeriods() {
      periodSelect.innerHTML = "";
      PERIODS.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.label;
        periodSelect.appendChild(opt);
      });
      periodSelect.value = "2026Q1";
    }
    periodSelect.addEventListener("change", render);
    function currentPeriod() {
      const id = periodSelect.value;
      return PERIODS.find(x => x.id === id) || PERIODS[0];
    }

    /**********************
     * ë Œë”
     **********************/
    function render() {
      const p = currentPeriod();
      const today = todayYmd();

      const allDays = dateRange(p.start, p.end);
      const workingDays = allDays.filter(isWorkingDay);

      // ì„ íƒ ë‚ ì§œ ë³´ì • (ê¸°ê°„/working day ë²”ìœ„)
      if (!selectedDate || !workingDays.includes(selectedDate)) {
        selectedDate = workingDays.includes(today) ? today : (workingDays[0] || null);
      }
      if (selectedDateLabel) selectedDateLabel.textContent = selectedDate || "-";
      if (selectedStatusPill) {
        const selIsLeave = !!(leaves?.[selectedDate]);
        const selSub = normalizeSubmission(submissions?.[selectedDate]);
        const selStatus = selIsLeave ? "leave" : (selSub?.status || "none");
        selectedStatusPill.className = "status-pill";
        if (selStatus === "leave") { selectedStatusPill.textContent = "ì—°ì°¨"; selectedStatusPill.classList.add("leave"); }
        else if (selStatus === "approved") { selectedStatusPill.textContent = "ì¸ì¦ ì™„ë£Œ"; selectedStatusPill.classList.add("approved"); }
        else if (selStatus === "pending") { selectedStatusPill.textContent = "ê²€ìˆ˜ì¤‘"; selectedStatusPill.classList.add("pending"); }
        else if (selStatus === "rejected") { selectedStatusPill.textContent = "ë¶€ì ê²©"; selectedStatusPill.classList.add("rejected"); }
        else { selectedStatusPill.textContent = "-"; }
      }


      const targetDaysList = workingDays.filter(d => !leaves?.[d]);
      const targetDays = targetDaysList.length;

      let done = 0;
      for (const d of targetDaysList) {
        const sub = normalizeSubmission(submissions?.[d]);
        if (!sub) continue;
        if (sub.status !== "approved") continue;
        done += 1;
      }

      const rate = targetDays > 0 ? done / targetDays : 0;
      const pass = rate >= 0.85;
      const required = Math.ceil(targetDays * 0.85);
      const remaining = Math.max(0, required - done);

      // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
      progressBar.style.width = (rate * 100) + "%";
      if (pass) {
        progressBar.classList.add("success");
      } else {
        progressBar.classList.remove("success");
      }

      // ë‚¨ì€ ì œì¶œ ìˆ˜ í…ìŠ¤íŠ¸
      const remainTextEl = document.getElementById("remainText");
      if (pass) {
        remainTextEl.innerHTML = `<span class="success">ğŸ‰ <b>ë¯¸ì…˜ ì„±ê³µ!</b> ëª¨ë“  ì¡°ê±´ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.</span>`;
        remainTextEl.className = "progress-text success";
      } else {
        remainTextEl.innerHTML = `ğŸ‘‰ ì•ìœ¼ë¡œ <b>${remaining}ë²ˆ</b>ë§Œ ë” ì œì¶œí•˜ë©´ <b>ë¯¸ì…˜ ì„±ê³µ(85%)</b>ì´ì—ìš”!`;
        remainTextEl.className = "progress-text";
      }

      // ì§‘ê³„ í‘œì‹œ
      statWD.textContent = workingDays.length;
      statTarget.textContent = targetDays;
      statDone.textContent = done;
      statRate.textContent = (rate * 100).toFixed(1) + "%";

      // ìƒíƒœ ë°°ì§€
      if (pass) {
        passBadge.innerHTML = "âœ… ë¯¸ì…˜ ì„±ê³µ!";
        passBadge.className = "result-badge success";
        statusBadge.innerHTML = "ğŸ‰ ë¯¸ì…˜ ì„±ê³µ";
        statusBadge.className = "status-badge success";
      } else {
        passBadge.innerHTML = "â³ ì§„í–‰ ì¤‘";
        passBadge.className = "result-badge pending";
        statusBadge.innerHTML = "â³ ì§„í–‰ ì¤‘";
        statusBadge.className = "status-badge pending";
      }

      // ìº˜ë¦°ë” ë Œë”
      grid.innerHTML = "";
      if (workingDays.length === 0) return;

      const firstIdx = mondayBasedIndex(workingDays[0]) ?? 0;
      for (let i = 0; i < firstIdx; i++) {
        const blank = document.createElement("div");
        blank.className = "cell";
        blank.style.visibility = "hidden";
        blank.style.cursor = "default";
        grid.appendChild(blank);
      }

      workingDays.forEach(d => {
        const c = document.createElement("div");
        c.className = "cell";

        const isLeave = !!leaves?.[d];
        const sub = normalizeSubmission(submissions?.[d]);
        const status = sub?.status || null;
        const isToday = d === today;

        if (isLeave) c.classList.add("leave");
        else if (status === "approved") c.classList.add("done");
        else if (status === "pending") c.classList.add("pending");
        else if (status === "rejected") c.classList.add("rejected");

        if (!leaveMode && selectedDate === d) c.classList.add("selected");
        if (isToday) c.classList.add("today");

        // ìƒíƒœ ì•„ì´ì½˜ ê²°ì •
        let statusIcon = "";
        if (isLeave) statusIcon = "ğŸ–ï¸";
        else if (status === "approved") statusIcon = "âœ…";
        else if (status === "pending") statusIcon = "ğŸ•’";
        else if (status === "rejected") statusIcon = "âš ï¸";
        else statusIcon = "â—‹";

        let statusText = "";
        if (isLeave) statusText = "ì—°ì°¨";
        else if (status === "approved") statusText = "ì¸ì¦ ì™„ë£Œ";
        else if (status === "pending") statusText = "ê²€ìˆ˜ì¤‘";
        else if (status === "rejected") statusText = "ë¶€ì ê²©";
        else statusText = "";

        c.innerHTML = `
          <div class="date">${d.slice(5)}</div>
          <div class="status-icon">${statusIcon}</div>
          <div class="status-text">${statusText}</div>
        `;

        c.onclick = async () => {
          if (leaveMode) {
            const ref = db.ref(`users/${currentUser}/leaves/${d}`);
            const s = await ref.get();
            s.exists() ? ref.remove() : ref.set(true);
            await loadUserData();
            render();
            return;
          }

          selectedDate = d;
          if (selectedDateLabel) selectedDateLabel.textContent = selectedDate;

          if (leaves?.[d]) {
            setUploadMessage("ì„ íƒí•œ ë‚ ì§œëŠ” ì—°ì°¨ë¡œ í‘œì‹œë˜ì–´ ìˆì–´ ì œì¶œí•  ìˆ˜ ì—†ì–´ìš”.", "warning");
          } else {
            setUploadMessage("");
          }

          render();
        };

        grid.appendChild(c);
      });
    }

    /**********************
     * ì‹œì‘
     **********************/
    (async () => {
      initPeriods();
      try { await ensureAnonAuth(); } catch (e) { console.error("anon auth failed:", e); }
      await loadEmployees();
      setModeLeave(false);
    })().catch(e => { console.error(e); });

  </script>
</body>
</html>
