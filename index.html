<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸ - í…€ë¸”ëŸ¬ ë¯¸ì…˜</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      background: #fafafa;
      color: #111827;
    }

    /* ë¸Œëœë“œ íƒ€ì´í‹€ */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .brand img { width: 34px; height: 34px; object-fit: contain; }
    .brand h2 { margin: 0; font-size: 18px; line-height: 1.2; }

    .row { margin: 10px 0; }

    /* ë¡œê·¸ì¸ ë°•ìŠ¤ */
    .login-box {
      max-width: 380px;
      margin-top: 10px;
      padding: 20px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    label { font-weight: 700; display: inline-flex; align-items: baseline; gap: 6px; }
    .hint8 { font-size: 8pt; font-weight: 500; color: #6b7280; }

    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      margin-top: 6px;
      box-sizing: border-box;
      background: #fff;
    }

    button {
      width: 100%;
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-weight: 800;
      cursor: pointer;
    }
    button:hover { background: #f9fafb; }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    .muted { color: #6b7280; font-size: 13px; line-height: 1.5; }

    /* ë¡œê·¸ì¸ í›„ ìƒë‹¨ */
    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    /* ì•ˆë‚´ ë¬¸êµ¬ ë°•ìŠ¤ */
    .notice {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 14px;
      margin: 10px 0 14px;
    }

    /* ì§‘ê³„ ì¹´ë“œ */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 12px 0 10px;
    }
    .stat {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
    }
    .stat .k { color:#6b7280; font-size: 12px; margin-bottom: 4px; }
    .stat .v { font-size: 18px; font-weight: 900; }

    .tag-ok {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid #bbf7d0;
      background:#ecfdf5;
      color:#065f46;
    }
    .tag-warn {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid #fed7aa;
      background:#fff7ed;
      color:#9a3412;
    }

    /* ìº˜ë¦°ë” */
    .calendar-card {
      position: relative;
      border-radius: 18px;
      padding: 18px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      margin-top: 12px;
      overflow: hidden;
    }
    .calendar-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url("grape.png") center/contain no-repeat;
      opacity: 0.5;
      pointer-events: none;
    }

    /* ì›”~ê¸ˆ 5ì—´ */
    .calendar-grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    .cell {
      border-radius: 14px;
      padding: 12px 8px;
      text-align: center;
      background: rgba(255,255,255,.92);
      border: 1px solid #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    .cell .d { font-weight: 900; }

    .cell.done {
      background: #7c3aed;
      color: #fff;
      border-color: #7c3aed;
    }
    .cell.leave {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }

    @media (max-width: 680px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 480px) {
      body { margin: 14px; }
      .calendar-grid { gap: 6px; }
      .cell { padding: 10px 6px; }
      .brand h2 { font-size: 16px; }
    }
  </style>
</head>

<body>
  <!-- âœ… ë¡œê·¸ì¸ ì „ ì œëª©(ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬) -->
  <div class="brand" id="brandLogin">
    <img src="logo.png" alt="logo" />
    <h2>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸ - í…€ë¸”ëŸ¬ ë¯¸ì…˜</h2>
  </div>

  <!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
  <div id="loginBox" class="login-box">
    <div class="row">
      <label>ì˜ë¬¸ ì´ë¦„</label>
      <select id="userSelect"></select>
    </div>

    <div class="row">
      <label>PIN 4ìë¦¬ <span class="hint8">(íœ´ëŒ€ë²ˆí˜¸ ë’·4ìë¦¬)</span></label>
      <input id="pin" type="password" maxlength="4" inputmode="numeric" />
    </div>

    <button id="loginBtn">ë¡œê·¸ì¸</button>
    <p id="loginMsg"></p>
  </div>

  <!-- âœ… ë¡œê·¸ì¸ í›„ í™”ë©´ -->
  <div id="app" style="display:none">
    <!-- âœ… ë¡œê·¸ì¸ í›„ ì œëª©(ì´ê²ƒë§Œ ë‚¨ê¹€) -->
    <div class="brand" id="brandApp">
      <img src="logo.png" alt="logo" />
      <h2>2026 í™˜ê²½ë³´í˜¸ìº í˜ì¸ - í…€ë¸”ëŸ¬ ë¯¸ì…˜</h2>
    </div>

    <!-- âœ… ì•ˆë‚´ ë¬¸êµ¬(ìš”ì²­ 2ë²ˆ) -->
    <div class="notice">
      <div class="muted"><b>Working day ê¸°ì¤€ ì¸ì¦ìƒ· ì œì¶œ 85% ì´ìƒ ì‹œ ë¯¸ì…˜ ì„±ê³µ!</b></div>
      <div class="muted">ì¸ì¦ìƒ·ì€ ì¶”í›„ ì œì¶œì–‘ì‹(pptíŒŒì¼)ì— ë§ì¶”ì–´ ì´ë©”ì¼ë¡œ ì œì¶œí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="topbar">
      <span class="pill" id="who"></span>
      <span class="pill">ì˜¤ëŠ˜: <b id="todayLabel"></b></span>
      <span class="pill">ìƒíƒœ: <b id="passText">-</b></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="submitBtn">í…€ë¸”ëŸ¬ ì¸ì¦ìƒ· ë¯¸ì…˜ Clear</button>
      <button id="leaveBtn">ì—°ì°¨ ëª¨ë“œ: OFF</button>
      <span class="pill">í˜„ì¬: <b id="modeText">ì œì¶œ</b></span>
    </div>

    <div class="row" style="margin-top:12px;">
      <label>ë¶„ê¸° ì„ íƒ</label>
      <select id="periodSelect"></select>
    </div>

    <!-- âœ… ë¶„ê¸°ë³„ ì§‘ê³„(ìš”ì²­ 3ë²ˆ) -->
    <div class="stats">
      <div class="stat">
        <div class="k">ì´ Working day</div>
        <div class="v" id="statWD">-</div>
      </div>
      <div class="stat">
        <div class="k">ì—°ì°¨ ì œì™¸ ì¼ìˆ˜</div>
        <div class="v" id="statTarget">-</div>
      </div>
      <div class="stat">
        <div class="k">ë¯¸ì…˜ ì„±ê³µ ì¼ìˆ˜(ì œì¶œ)</div>
        <div class="v" id="statDone">-</div>
      </div>
      <div class="stat">
        <div class="k">ë‹¬ì„±ë¥ </div>
        <div class="v" id="statRate">-</div>
      </div>
    </div>

    <div id="passBadge"></div>
    <div id="remainText" class="muted" style="margin-top:6px;"></div>

    <div class="calendar-card">
      <div class="calendar-grid" id="grid"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /**********************
     * Firebase Config
     **********************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      databaseURL: "https://tumblermission-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /**********************
     * ë¶„ê¸° ëª©ë¡
     **********************/
    const PERIODS = [
      { id: "2026Q1", start: "2026-01-12", end: "2026-03-31", label: "2026Q1 (01/12~03/31)" },
      { id: "2026Q2", start: "2026-04-01", end: "2026-06-30", label: "2026Q2 (04/01~06/30)" },
      { id: "2026Q3", start: "2026-07-01", end: "2026-09-30", label: "2026Q3 (07/01~09/30)" },
      { id: "2026Q4", start: "2026-10-01", end: "2026-11-15", label: "2026Q4 (10/01~11/15)" }
    ];

    /**********************
     * ê³µíœ´ì¼/íœ´ë¬´ì¼(ìš”ì²­ ë°˜ì˜)
     **********************/
    const HOLIDAYS_2026 = new Set([
      "2026-02-16","2026-02-17","2026-02-18",
      "2026-03-02",
      "2026-05-01","2026-05-05","2026-05-25",
      "2026-06-03",
      "2026-08-17",
      "2026-09-24","2026-09-25",
      "2026-10-05","2026-10-09",
    ]);

    /**********************
     * DOM
     **********************/
    const brandLogin = document.getElementById("brandLogin");

    const userSelect = document.getElementById("userSelect");
    const pinInput = document.getElementById("pin");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const loginBox = document.getElementById("loginBox");
    const app = document.getElementById("app");

    const who = document.getElementById("who");
    const todayLabel = document.getElementById("todayLabel");
    const grid = document.getElementById("grid");

    const submitBtn = document.getElementById("submitBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const modeText = document.getElementById("modeText");
    const periodSelect = document.getElementById("periodSelect");

    const statWD = document.getElementById("statWD");
    const statTarget = document.getElementById("statTarget");
    const statDone = document.getElementById("statDone");
    const statRate = document.getElementById("statRate");
    const passBadge = document.getElementById("passBadge");
    const passText = document.getElementById("passText");

    /**********************
     * ìƒíƒœ
     **********************/
    let currentUser = null;
    let submissions = {};
    let leaves = {};
    let leaveMode = false; // false=ì œì¶œ, true=ì—°ì°¨

    /**********************
     * ìœ í‹¸
     **********************/
    function todayYmd() {
      const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
      return d.toISOString().slice(0, 10);
    }

    function isWeekend(ymd) {
      const day = new Date(ymd + "T00:00:00+09:00").getDay();
      return day === 0 || day === 6;
    }

    function isLaborDay(ymd) {
      return ymd.endsWith("-05-01");
    }

    // working day = ì›”~ê¸ˆ + (ê³µíœ´ì¼/5.1 ì œì™¸)
    function isWorkingDay(ymd) {
      if (isWeekend(ymd)) return false;
      if (HOLIDAYS_2026.has(ymd)) return false;
      if (isLaborDay(ymd)) return false;
      return true;
    }

    function dateRange(startYmd, endYmd) {
      const out = [];
      let d = new Date(startYmd + "T00:00:00+09:00");
      const e = new Date(endYmd + "T00:00:00+09:00");
      while (d <= e) {
        out.push(d.toISOString().slice(0,10));
        d.setDate(d.getDate() + 1);
      }
      return out;
    }

    // ì›”~ê¸ˆ ì¸ë±ìŠ¤(ë‹¬ë ¥ ì •ë ¬ìš©)
    function mondayBasedIndex(ymd) {
      const d = new Date(ymd + "T00:00:00+09:00").getDay();
      const map = {1:0,2:1,3:2,4:3,5:4}; // Mon..Fri
      return map[d];
    }

    /**********************
     * ë°ì´í„° ë¡œë“œ
     **********************/
    async function loadEmployees() {
      const snap = await db.ref("employees").get();
      userSelect.innerHTML = "";
      if (!snap.exists()) return;

      snap.forEach(c => {
        const v = c.val();
        if (v && v.active) {
          const o = document.createElement("option");
          o.value = c.key;
          o.textContent = c.key;
          userSelect.appendChild(o);
        }
      });
    }

    async function loadUserData() {
      submissions = (await db.ref(`users/${currentUser}/submissions`).get()).val() || {};
      leaves = (await db.ref(`users/${currentUser}/leaves`).get()).val() || {};
    }

    /**********************
     * ë¡œê·¸ì¸
     **********************/
    async function login() {
      const u = userSelect.value;
      const p = pinInput.value;

      if (!u) {
        loginMsg.innerHTML = `<span style="color:#b91c1c;font-weight:800;">ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      const snap = await db.ref(`employees/${u}`).get();
      if (!snap.exists()) {
        loginMsg.innerHTML = `<span style="color:#b91c1c;font-weight:800;">ì§ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      const emp = snap.val();
      if (!emp.active) {
        loginMsg.innerHTML = `<span style="color:#b91c1c;font-weight:800;">ë¹„í™œì„± ê³„ì •ì…ë‹ˆë‹¤.</span>`;
        return;
      }

      if (String(emp.pin) !== String(p)) {
        loginMsg.innerHTML = `<span style="color:#b91c1c;font-weight:800;">PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      currentUser = u;
      await loadUserData();

      // âœ… (ìš”ì²­ 1) ì œëª© 2ê°œ ë¬¸ì œ í•´ê²°: ë¡œê·¸ì¸ ì „ ì œëª© ìˆ¨ê¹€
      brandLogin.style.display = "none";

      // ë¡œê·¸ì¸ í™”ë©´ ì‚¬ë¼ì§€ê³  ì•± í‘œì‹œ
      loginBox.style.display = "none";
      app.style.display = "block";

      who.textContent = `ë¡œê·¸ì¸: ${u}`;
      todayLabel.textContent = todayYmd();

      render();
    }

    loginBtn.onclick = login;
    pinInput.addEventListener("keydown", e => {
      if (e.key === "Enter") login();
    });

    /**********************
     * ëª¨ë“œ
     **********************/
    function setModeLeave(on) {
      leaveMode = on;
      modeText.textContent = leaveMode ? "ì—°ì°¨" : "ì œì¶œ";
      leaveBtn.textContent = `ì—°ì°¨ ëª¨ë“œ: ${leaveMode ? "ON" : "OFF"}`;
    }
    submitBtn.onclick = () => setModeLeave(false);
    leaveBtn.onclick = () => setModeLeave(!leaveMode);

    /**********************
     * ë¶„ê¸° ì˜µì…˜
     **********************/
    function initPeriods() {
      periodSelect.innerHTML = "";
      PERIODS.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.label;
        periodSelect.appendChild(opt);
      });
      periodSelect.value = "2026Q1";
    }
    periodSelect.addEventListener("change", render);

    function currentPeriod() {
      const id = periodSelect.value;
      return PERIODS.find(x => x.id === id) || PERIODS[0];
    }

    /**********************
     * ë Œë”
     **********************/
    function render() {
      const p = currentPeriod();

      // ë¶„ê¸° ì „ì²´ ë‚ ì§œ
      const allDays = dateRange(p.start, p.end);

      // ì´ working day
      const workingDays = allDays.filter(isWorkingDay);

      // ì—°ì°¨ ì œì™¸ í›„ ëª©í‘œì¼ìˆ˜
      const targetDaysList = workingDays.filter(d => !leaves?.[d]);
      const targetDays = targetDaysList.length;

      // ì„±ê³µ(=ì œì¶œ) ì¼ìˆ˜
      let done = 0;
      for (const d of targetDaysList) if (submissions?.[d]) done += 1;

      const rate = targetDays > 0 ? done / targetDays : 0;
      const pass = rate >= 0.85;
      // âœ… ë¯¸ì…˜ ì„±ê³µê¹Œì§€ ë‚¨ì€ ì œì¶œ ìˆ˜ ê³„ì‚°
      const required = Math.ceil(targetDays * 0.85);
      const remaining = Math.max(0, required - done);

      // ë¬¸êµ¬ ì¶œë ¥
      const remainTextEl = document.getElementById("remainText");
      if (pass) {
       remainTextEl.innerHTML = `<span class="ok">ğŸ‰ ë¯¸ì…˜ ì„±ê³µ! ëª¨ë“  ì¡°ê±´ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.</span>`;
      } else {
       remainTextEl.innerHTML =
      `ğŸ‘‰ <b>ì•ìœ¼ë¡œ ${remaining}ë²ˆ</b>ë§Œ ë” ì œì¶œí•˜ë©´ <b>ë¯¸ì…˜ ì„±ê³µ(85%)</b>ì´ì—ìš”!`;
       }

      // âœ… (ìš”ì²­ 3) ì§‘ê³„ í‘œì‹œ
      statWD.textContent = workingDays.length;
      statTarget.textContent = targetDays;
      statDone.textContent = done;
      statRate.textContent = (rate * 100).toFixed(1) + "%";

      // ìƒíƒœ ë°°ì§€
      passText.textContent = pass ? "ë¯¸ì…˜ ì„±ê³µ" : "ì§„í–‰ ì¤‘";
      passBadge.innerHTML = pass
        ? `<span class="tag-ok">âœ… 85% ë‹¬ì„± (ë¯¸ì…˜ ì„±ê³µ)</span>`
        : `<span class="tag-warn">â³ ì•„ì§ 85% ë¯¸ë§Œ</span>`;

      // âœ… ìº˜ë¦°ë” ë Œë”: ì›”~ê¸ˆ 5ì—´, ë‹¬ë ¥ì²˜ëŸ¼ ì²« ì£¼ ë¹ˆì¹¸ ì‚½ì…
      grid.innerHTML = "";
      if (workingDays.length === 0) return;

      const firstIdx = mondayBasedIndex(workingDays[0]) ?? 0;
      for (let i = 0; i < firstIdx; i++) {
        const blank = document.createElement("div");
        blank.className = "cell";
        blank.style.visibility = "hidden";
        blank.style.cursor = "default";
        grid.appendChild(blank);
      }

      workingDays.forEach(d => {
        const c = document.createElement("div");
        c.className = "cell";

        const isLeave = !!leaves?.[d];
        const isDone = !!submissions?.[d];

        if (isLeave) c.classList.add("leave");
        else if (isDone) c.classList.add("done");

        c.innerHTML = `<div class="d">${d.slice(5)}</div>`;

        c.onclick = async () => {
          // ì—°ì°¨ ëª¨ë“œë©´ leavesì— ê¸°ë¡, ì•„ë‹ˆë©´ submissionsì— ê¸°ë¡
          const ref = leaveMode
            ? db.ref(`users/${currentUser}/leaves/${d}`)
            : db.ref(`users/${currentUser}/submissions/${d}`);

          const s = await ref.get();
          s.exists() ? ref.remove() : ref.set(true);

          await loadUserData();
          render();
        };

        grid.appendChild(c);
      });
    }

    /**********************
     * ì‹œì‘
     **********************/
    initPeriods();
    loadEmployees();
    setModeLeave(false);
  </script>
</body>
</html>
